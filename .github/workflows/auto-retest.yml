name: Auto Retest Failed Konflux Build Checks

on:
  check_run:
    types: [completed]

env:
  MAX_RETRIES: 3

jobs:
  auto-retest:
    # removed for testing: github.event.check_run.conclusion == 'failure' &&
    if: |
      github.event.check_run.pull_requests[0] != null &&
      
      contains(github.event.check_run.name, 'operator-index-ocp-v') &&
      endsWith(github.event.check_run.name, '-on-push')

    runs-on: ubuntu-latest

    permissions:
      pull-requests: write
      issues: write

    steps:
      - name: Get check name
        id: get-check-name
        run: |
          CHECK_NAME="${{ github.event.check_run.name }}"
          # Strip "Red Hat Konflux / " prefix if present
          CHECK_NAME="${CHECK_NAME#Red Hat Konflux / }"
          echo "check_name=$CHECK_NAME" >> $GITHUB_OUTPUT

      - name: Get PR number
        id: get-pr
        run: |
          PR_NUMBER="${{ github.event.check_run.pull_requests[0].number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Check retry count
        id: check-retries
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHECK_NAME: ${{ steps.get-check-name.outputs.check_name }}
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
          MAX_RETRIES: ${{ env.MAX_RETRIES }}
        run: |
          COMMENTS=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json comments -q '.comments[].body')

          # Count how many times we've already retested this specific check
          RETEST_COMMAND="/retest $CHECK_NAME"
          RETRY_COUNT=$(echo "$COMMENTS" | grep -c "$RETEST_COMMAND" || true)

          echo "Current retry count: $RETRY_COUNT"

          if [ "$RETRY_COUNT" -ge "$MAX_RETRIES" ]; then
            echo "should_retry=false" >> $GITHUB_OUTPUT
            echo "Max retries ($MAX_RETRIES) reached for $CHECK_NAME"
          else
            echo "should_retry=true" >> $GITHUB_OUTPUT
            echo "Will retry (attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
          fi

      - name: Add retest comment
        if: steps.check-retries.outputs.should_retry == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHECK_NAME: ${{ steps.get-check-name.outputs.check_name }}
          PR_NUMBER: ${{ steps.get-pr.outputs.pr_number }}
        run: |
          COMMENT_BODY="/retest $CHECK_NAME"

          gh pr comment "$PR_NUMBER" \
            --repo ${{ github.repository }} \
            --body "$COMMENT_BODY"

      - name: Log max retries reached
        if: steps.check-retries.outputs.should_retry == 'false'
        run: |
          echo "::warning::Maximum retry limit (${{ env.MAX_RETRIES }}) reached for ${{ steps.get-check-name.outputs.check_name }} on PR #${{ steps.get-pr.outputs.pr_number }}"
